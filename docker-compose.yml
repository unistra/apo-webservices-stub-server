# syntax=docker/dockerfile:1.4

# start/stop:
#  docker compose build # build images
#  docker compose up -d # start services
#  docker compose down # stop services
#  docker compose down --volumes # stop services and drop data
# variables:
#  - APPLI_ADMIN_TECHNIQUE — login de l'admin technique ($USER par défaut)
#  - APP_APOGEE_UNIVERSITY_CODE — code université (UNIV par défaut)
#  - APP_APOGEE_UNIVERSITY_CODE — code université (UNIVERSITÉ par défaut)
# files:
#  - .env — environment variables
#  - dataset/*.yml — Données de test (apogeews stub)
# urls:
#  - http://localhost — ESUP Stage
#  - http://cas.localhost/cas/login — CAS (any user, any password)
#  - http://webmail.localhost — MailDev
#  - http://db.localhost — PHP My Admin
#  - http://esup-siscol.localhost — ESUP Scol
#  - http://apogeews.localhost — Apogee Web Services (Stub)
#  - http://ingress.localhost — Træfik Dashboard
# ports:
#  - 80 http
#  - 389 ldap (bind-dn: uid=estage,ou=apps,dc=univ,dc=fr bind-password: changeme)
#  - 3306 mariadb
#  - 8001 DEBUG esup-stage
#  - 8002 DEBUG esup-siscol
#  - 8080 esup-stage en direct
#  - 8081 esup-siscol en direct
#  - 8082 apogeews en direct

configs:
  application-esup-stage.yml:
    content: |
      cas:
        url:
          service: ${CAS_URL_SERVICE:-http://cas.localhost/cas}
          
      appli:
        prefix: http://localhost
        url: http://localhost/
        local-api: http://esup-stage.localhost
        admin_technique: ${APPLI_ADMIN_TECHNIQUE:-$USER}
        data_dir: /srv
        datasource:
          driver: org.mariadb.jdbc.Driver
          url: jdbc:mariadb://mariadb:3306/estage?sslMode=disable
          username: ${APPLI_DATASOURCE_USERNAME:-esup_stage}
          password: ${APPLI_DATASOURCE_PASSWORD:-changeme}
        mailer:
          protocol: smtp
          host: maildev
          ssl:
            enable: true
          port: 1025
          auth: true
          username: ${APPLI_MAILER_USERNAME:-esup-stage@localhost}
          password: ${APPLI_MAILER_PASSWORD:-changeme}
          from: esup-stage@esup-stage.localhost
          #disable_delivery: false
          #delivery_address: ${APPLI_ADMIN_TECHNIQUE:-$USER}@localhost
      referentiel:
        ws:
          ldap_url: http://esup-siscol.localhost/ldap
          apogee_url: http://esup-siscol.localhost/apogee
          login: ${REFERENTIEL_WS_LOGIN:-estage}
          password: ${REFERENTIEL_WS_PASSWORD:-changeme}
  application-esup-siscol.yml:
    content: |
      env:
        apogee:
          urlService: http://apogeews.localhost/services
          username: ${REFERENTIEL_WS_LOGIN:-estage}
          password: ${REFERENTIEL_WS_PASSWORD:-changeme}
      app:
        mode_apogee: true
        mode_pegase: false
        server-url: http://esup-siscol.localhost
        server-title: Client API SCOLARITE REST [docker-compose]
        apogee:
          universityCode: ${APP_APOGEE_UNIVERSITY_CODE:-UNIV}
          # valeurs possible TOUS N O#
          temoinRecupAnnu: ${APP_APOGEE_TEMOIN_RECUP_ANNU:-N}
          urlService:
            administratifMetier: $${env.apogee.urlService}/AdministratifMetier
            administratifMetierUserName: $${env.apogee.username}
            administratifMetierPassword: $${env.apogee.password}
            etudiantMetier: $${env.apogee.urlService}/EtudiantMetier
            etudiantMetierUserName: $${env.apogee.username}
            etudiantMetierPassword: $${env.apogee.password}
            pedagogiqueMetier: $${env.apogee.urlService}/PedagogiqueMetier
            pedagogiqueMetierUserName: $${env.apogee.username}
            pedagogiqueMetierPassword: $${env.apogee.password}
            geographieMetier: $${env.apogee.urlService}/GeographieMetier
            geographieMetierUserName: $${env.apogee.username}
            geographieMetierPassword: $${env.apogee.password}
            referentielMetier: $${env.apogee.urlService}/ReferentielMetier
            referentielMetierUserName: $${env.apogee.username}
            referentielMetierPassword: $${env.apogee.password}
            offreFormationMetier: $${env.apogee.urlService}/OffreFormationMetier
            offreFormationMetierUserName: $${env.apogee.username}
            offreFormationMetierPassword: $${env.apogee.password}
        ldap:
          attributes:
            base-dn: ""
      spring:
        ldap:
          urls: [ "ldap://apogeews.localhost:389" ]
          username: uid=${REFERENTIEL_WS_LOGIN:-estage},ou=apps,dc=univ,dc=fr
          password: ${REFERENTIEL_WS_PASSWORD:-changeme}
          base: ou=people,dc=univ,dc=fr
      credential:
        userscredential:
          ${REFERENTIEL_WS_LOGIN:-estage}:
            username: ${REFERENTIEL_WS_LOGIN:-estage}
            password: ${REFERENTIEL_WS_PASSWORD:-changeme}
            roles: [ ADMIN, USER, USER_APOGEE, USER_LDAP ]
      logging:
        level:
          org.springframework.ldap.core: DEBUG
  application-apogeews.yml:
    content: |
      spring:
        ldap:
          base: ou=people,dc=univ,dc=fr
          embedded:
            base-dn:
            - dc=univ,dc=fr
            - ou=apps,dc=univ,dc=fr
            - ou=people,dc=univ,dc=fr
            credential:
              username: uid=${REFERENTIEL_WS_LOGIN:-estage},ou=apps,dc=univ,dc=fr
              password: ${REFERENTIEL_WS_PASSWORD:-changeme}
      app:
        apogee:
          university-code: ${APP_APOGEE_UNIVERSITY_CODE:-UNIV}
          university-libelle: ${APP_APOGEE_UNIVERSITY_LIBELLE:-UNIVERSITÉ}
      dataset:
        files: file:/srv/**/*.yml
  configUrlServices.properties:
    content: |
      geographieMetier.urlService=
      offreFormationMetier.urlService=
      etudiantMetier.urlService=
      administratifMetier.urlService=
      geographieMetier.username=
      geographieMetier.password=
      offreFormationMetier.username=
      offreFormationMetier.password=
      pedagogiqueMetier.username=
      pedagogiqueMetier.password=
      etudiantMetier.username=
      etudiantMetier.password=
      administratifMetier.username=
      administratifMetier.password=
  admin-technique.yml:
    content: |
      - ldap:
          uid: ${APPLI_ADMIN_TECHNIQUE:-$USER}
          sn: [ ${APPLI_ADMIN_TECHNIQUE:-$USER} ]
          givenName: [ ${APPLI_ADMIN_TECHNIQUE:-$USER} ]
          supannAliasLogin: ${APPLI_ADMIN_TECHNIQUE:-$USER} 
          mail: ${APPLI_ADMIN_TECHNIQUE:-$USER}@univ.fr
          eduPersonPrimaryAffiliation: staff
          eduPersonAffiliation: [staff, member]
  cas.yml:
    content: |
      server:
        http:
          enabled: false
        port: 80
        ssl:
          enabled: false
        httpProxy:
          enabled: true
          secure: true
          scheme: https
          protocol: HTTP/1.1
        tomcat:
          accesslog:
            check-exists: false
          remoteip:
            internal-proxies:
            protocol-header-https-value: http
      cas:
        server:
          name: http://cas.localhost
          prefix: http://cas.localhost/cas
          tomcat:
            http-proxy:
              enabled: true
              protocol:
              scheme: http
              secure: true
        http-web-request:
          cors:
            enabled: true
            allow-origin-patterns[0]: '*'
        authn:
          accept:
            enabled: false
          groovy:
            location: file:///etc/cas/authn-any.groovy
        serviceRegistry:
          core:
            init-from-json: true
          json:
            location: file:/etc/cas/services/
            watcher-enabled: false
        monitor:
          endpoints:
            endpoint:
              defaults:
                access: ANONYMOUS
              registeredServices:
                access: ANONYMOUS
      management:
        endpoints:
          web:
            exposure:
              include: "*"
          access:
            default: unrestricted
            registeredServices: unrestricted
        health:
          readiness-state:
            enabled: true
          liveness-state:
            enabled: true
        endpoint:
          health:
            probes:
              enabled: true
  authn-any.groovy:
    content: |
      import org.apereo.cas.authentication.*
      import org.apereo.cas.authentication.credential.*
      import org.apereo.cas.authentication.metadata.*
      import javax.security.auth.login.*

      def authenticate(final Object... args) {
          def (authenticationHandler,credential,servicesManager,principalFactory,logger) = args
          def principal = principalFactory.createPrincipal(credential.username);
          logger.info("Authenticating user $$credential.username with any password")
          return new DefaultAuthenticationHandlerExecutionResult(authenticationHandler,
              credential, principal, new ArrayList<>(0));
      }

      def supportsCredential(final Object... args) {
          def (credential,logger) = args
          return credential != null
      }

      def supportsCredentialClass(final Object... args) {
          def (credentialClazz,logger) = args
          return credentialClazz == UsernamePasswordCredential.class
      }
  localhost-10000001.json:
    content: |
      {
        "@class": "org.apereo.cas.services.CasRegisteredService",
        "serviceId": "^http://(.*[.])?localhost/.*",
        "name": "localhost",
        "id": 10000001,
      }

services:

  esup-stage:
    image: harbor.esup-portail.org/esup-stage/esup-stage:3.0.3-f4667ca
    labels:
      traefik.enable: "true"
      traefik.http.routers.esup-stage.rule: Host(`localhost`)
      traefik.http.services.esup-stage.loadbalancer.server.port: 8080
    command:
      - java
      - -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8001
      - -cp
      - /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/:/usr/local/tomcat/webapps/ROOT.war
      - org.springframework.boot.loader.launch.WarLauncher
    ports:
      - "8080"
      - "8001:8001"
    environment:
      SERVER_PORT: 8080
      SERVER_USE_FORWARD_HEADERS: true
    mem_limit: 2G
    user: 33:33
    volumes:
      - type: volume
        source: estage-data
        target: /srv
        read_only: false
      - type: volume
        source: theme
        target: /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/static
        read_only: false
    configs:
      - source: application-esup-stage.yml
        target: /usr/local/tomcat/config/application.yml
    depends_on:
      esup-stage-init:
        condition: service_completed_successfully
      esup-siscol:
        condition: service_started
      mariadb:
        condition: service_healthy
      maildev:
        condition: service_healthy
      ingress:
        condition: service_started

  esup-siscol:
    labels:
      traefik.enable: "true"
      traefik.http.routers.esup-siscol.rule: Host(`esup-siscol.localhost`)
      traefik.http.services.esup-siscol.loadbalancer.server.port: 8081
    build:
      args:
        VERSION: 2.1.2
      tags: [ "esup-siscol:2.1.2" ]
      context: https://github.com/EsupPortail/esup-siscol.git#2.1.2
      dockerfile_inline: |
        FROM eclipse-temurin:21-jdk-alpine
        ARG VERSION=2.1.2
        RUN apk update && apk upgrade && apk add --update tzdata && rm -rf /var/cache/apk/*
        ENV TZ=Europe/Paris
        RUN mkdir -p /esup-siscol /etc/esup-siscol \
          && wget -O /esup-siscol/esup-siscol.jar https://github.com/EsupPortail/esup-siscol/releases/download/$$VERSION/esup-siscol-$$VERSION.war
        COPY etc/esup-siscol /etc/esup-siscol      
        RUN mv /etc/esup-siscol/application.yml.sample /etc/esup-siscol/application.yml \
          && sed -i 's/\t/  /g;173s/^/    /' /etc/esup-siscol/application.yml \
          && sed -i 's/^\(\s*\)\(\w*[Pp]assword:\)/\1#\2/g' /etc/esup-siscol/application.yml
        WORKDIR /esup-siscol
        ENV SERVER_PORT=8081
        EXPOSE 8081
        CMD ["java", "-jar", "esup-siscol.jar"]
    environment:
      SERVER_PORT: 8081
      SERVER_USE_FORWARD_HEADERS: true
    command:
      - java
      - -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:8002
      - -jar
      - esup-siscol.jar
    configs:
      - source: application-esup-siscol.yml
        target: /esup-siscol/config/application.yml
      - source: configUrlServices.properties
        target: /esup-siscol/configUrlServices.properties
    ports:
      - "8081:8081"
      - "8002:8002"
    depends_on:
      apogeews:
        condition: service_started

  apogeews:
    labels:
      traefik.enable: "true"
      traefik.http.routers.apogeews.rule: Host(`apogeews.localhost`)
      traefik.http.services.apogeews.loadbalancer.server.port: 8082
      traefik.tcp.routers.apogeews-ldap.rule: ClientIP(`0.0.0.0/0`)
      traefik.tcp.routers.apogeews-ldap.entrypoints: ldap
      traefik.tcp.routers.apogeews-ldap.service: apogeews-ldap
      traefik.tcp.services.apogeews-ldap.loadbalancer.server.port: 389
    build:
      context: .
    ports:
      - "389"
      - "8082:8082"
    environment:
      SERVER_PORT: 8082
      SERVER_USE_FORWARD_HEADERS: true
    volumes:
      - type: bind
        source: dataset
        target: /srv/testdata
        read_only: true
    configs:
      - source: application-apogeews.yml
        target: /config/application-default.yml
      - source: admin-technique.yml
        target: /srv/admin-technique.yml
    container_name: apogeews

  esup-stage-init:
    image: harbor.esup-portail.org/esup-stage/esup-stage:3.0.3-f4667ca
    command:
      - bash
      - -c
      - |
        set -x
        /usr/bin/touch /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/static/theme.css
        chown 33:33 /srv/. /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/static/theme.css
    volumes:
      - type: volume
        source: estage-data
        target: /srv
        read_only: false
      - type: volume
        source: theme
        target: /usr/local/tomcat/webapps/ROOT/WEB-INF/classes/static
        read_only: false

  ingress:
    image: traefik:v3
    command:
    - --entryPoints.http.address=:80
    - --entryPoints.http.asDefault=true
    - --entryPoints.http.forwardedHeaders.insecure=true
    - --entryPoints.ldap.address=:389
    - --providers.docker
    - --providers.docker.exposedByDefault=false
    - --log=true
    - --accessLog=true
    - --accesslog.addinternals=true
    - --api.disabledashboardad=true
    ports:
      - "80:80"
      - "389:389"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    labels:
      traefik.enable: "true"
      traefik.http.routers.traefik-api.rule: Host(`ingress.localhost`) && PathPrefix(`/api`)
      traefik.http.routers.traefik-api.service: api@internal
      traefik.http.routers.traefik-api.priority: "999"
      traefik.http.routers.traefik-dashboard.rule: Host(`ingress.localhost`)
      traefik.http.routers.traefik-dashboard.service: dashboard@internal
      traefik.http.routers.traefik-dashboard.priority: "998"
    volumes:
      # So that Traefik can listen to the Docker events
      - type: bind
        source: ${DOCKER_SOCK:-/var/run/docker.sock}
        target: /var/run/docker.sock
    deploy:
      resources:
        limits:
          memory: 60M
        reservations:
          memory: 30M
    networks:
      default:
        aliases:
        - apogeews.localhost
        - esup-siscol.localhost

  mariadb:
    image: mariadb:10.3
    ports:
      - "3306:3306"
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-changeme}
      MARIADB_DATABASE: estage
      MARIADB_USER: ${APPLI_DATASOURCE_USERNAME:-esup_stage}
      MARIADB_PASSWORD: ${APPLI_DATASOURCE_PASSWORD:-changeme}
      MARIADB_MYSQL_LOCALHOST_USER: "1"
    user: 999:999
    cap_drop:
      - ALL
    mem_limit: 128M
    volumes:
      - type: volume
        source: mariadb-data
        target: /var/lib/mysql
        read_only: false
      - type: volume
        source: mariadb-data
        target: /docker-entrypoint-initdb.d/
        volume:
          subpath: docker-entrypoint-initdb.d
        read_only: true
    depends_on:
      ingress:
        condition: service_started
      mariadb-create-health-check-accounts:
        condition: service_completed_successfully
    healthcheck:
      test: [ "CMD", "healthcheck.sh", "--defaults-file=/var/lib/mysql/.healthcheck.cnf", "--connect", "--innodb_initialized" ]
      start_period: 1m
      start_interval: 1s
      interval: 1m
      timeout: 5s
      retries: 3
    networks:
      default:
        aliases: [ mariadb.localhost ]

  mariadb-create-health-check-accounts:
    image: mariadb:10.3
    command:
      - bash
      - -c
      - |
        set -e
        [ -f /srv/.healthcheck.cnf ] && exit 0
        mkdir -p /srv/docker-entrypoint-initdb.d
        healthCheckConnectPass="$$(pwgen 32 1)"
        for host in 127.0.0.1 ::1 localhost; do cat <<-EOF
        CREATE USER IF NOT EXISTS healthcheck@'$$host' IDENTIFIED BY '$$healthCheckConnectPass';
        SET PASSWORD FOR healthcheck@'$$host' = PASSWORD('$$healthCheckConnectPass');
        GRANT ${MARIADB_HEALTHCHECK_GRANTS:-USAGE} ON *.* TO healthcheck@'$$host';
        EOF
        done > /srv/docker-entrypoint-initdb.d/create_healthcheck_users.sql
        echo -e "[client]\\nhost=localhost\\nport=3306\\nuser=healthcheck\\npassword=$$healthCheckConnectPass\\n" > /srv/.healthcheck.cnf
        chmod 700 /srv/.healthcheck.cnf
        chown -R 999:999 /srv
    volumes:
      - type: volume
        source: mariadb-data
        target: /srv
        read_only: false

  phpmyadmin:
    image: phpmyadmin:5
    labels:
      traefik.enable: "true"
      traefik.http.routers.phpmyadmin.rule: Host(`db.localhost`)
    environment:
      PMA_HOST: mariadb
      PMA_ABSOLUTE_URI: http://db.localhost
      PMA_SSL: "0"
      PMA_USER: ${APPLI_DATASOURCE_USERNAME:-esup_stage}
      PMA_PASSWORD: ${APPLI_DATASOURCE_PASSWORD:-changeme}
    volumes:
      - type: volume
        source: phpmyadmin-sessions
        target: /sessions
        read_only: false
    depends_on:
      ingress:
        condition: service_started

  maildev:
    image: maildev/maildev:latest
    labels:
      traefik.enable: "true"
      traefik.http.routers.maildev.rule: Host(`webmail.localhost`)
      traefik.http.services.maildev.loadbalancer.server.port: 1080
    environment:
      MAILDEV_INCOMING_USER: ${MAILDEV_INCOMING_USER:-esup_stage}
      MAILDEV_INCOMING_PASS: ${MAILDEV_INCOMING_PASS:-changeme}
      MAILDEV_MAILDIR: /srv
    volumes:
      - type: volume
        source: mails
        target: /srv
        read_only: false
    depends_on:
      ingress:
        condition: service_started

  cas.localhost:
    build:
      dockerfile_inline: |
        ARG CAS_VERSION="7.2.4"
        FROM apereo/cas:$${CAS_VERSION} as cas
        # add zip as jar update messes up with cas.war existing content 
        RUN apt-get update && apt-get install -y --no-install-recommends zip \
          && rm -rf /var/lib/apt/lists/*
        ARG CAS_VERSION="7.2.4"
        # add org.apereo.cas:cas-server-support-generic & cas-server-core-scripting
        ADD https://repo.maven.apache.org/maven2/org/apereo/cas/cas-server-support-generic/$${CAS_VERSION}/cas-server-support-generic-$${CAS_VERSION}.jar \
            https://repo.maven.apache.org/maven2/org/apereo/cas/cas-server-core-scripting/$${CAS_VERSION}/cas-server-core-scripting-$${CAS_VERSION}.jar \
            https://repo.maven.apache.org/maven2/org/apache/groovy/groovy/4.0.26/groovy-4.0.26.jar \
            https://repo.maven.apache.org/maven2/org/apache/groovy/groovy-jsr223/4.0.26/groovy-jsr223-4.0.26.jar \
            https://repo.maven.apache.org/maven2/org/apache/groovy/groovy-templates/4.0.26/groovy-templates-4.0.26.jar \
            https://repo.maven.apache.org/maven2/org/apache/groovy/groovy-groovysh/4.0.26/groovy-groovysh-4.0.26.jar \
            WEB-INF/lib/
        # add additional libs to war
        RUN zip -ur0 cas.war WEB-INF/lib/
    labels:
      traefik.enable: "true"
      traefik.http.routers.cas.rule: Host(`cas.localhost`)
      traefik.http.routers.cas.middlewares: cas-ssl@docker
      #traefik.http.middlewares.cas-ssl.headers.sslProxyHeaders.X-Forwarded-Proto: https
      traefik.http.middlewares.cas-ssl.headers.customrequestheaders.X-Forwarded-Proto: https
      traefik.http.services.cas.loadbalancer.server.port: 80
    configs:
      - source: cas.yml
        target: /etc/cas/config/cas.yml
      - source: authn-any.groovy
        target: /etc/cas/authn-any.groovy
      - source: localhost-10000001.json
        target: /etc/cas/services/localhost-10000001.json

volumes:
  estage-data: {}
  mariadb-data: {}
  mails: {}
  theme: {}
  phpmyadmin-sessions: {}

networks:
  default:
    name: esup-stage
